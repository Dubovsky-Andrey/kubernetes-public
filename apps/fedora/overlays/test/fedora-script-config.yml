# fedora-script-config.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fedora-script
data:
  start.sh: |
    #!/bin/bash
    echo "Hello from overlay start.sh"
    ARGOCD_VERSION=v2.14.11
    KUSTOMIZE_VERSION=$KUSTOMIZE_VERSION
    KUBECTL_VERSION=v1.32.0

    dnf update -y
    dnf config-manager addrepo --from-repofile=https://rpm.releases.hashicorp.com/fedora/hashicorp.repo
    dnf install -y dnf-plugins-core uptime wget unzip openssh openssh-server ansible helm terraform # openvpn

    # Install kustomize
    echo "Install kustomize"
    curl -L https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F$KUSTOMIZE_VERSION/kustomize_$KUSTOMIZE_VERSION_linux_arm64.tar.gz
    tar zxvf kustomize_$KUSTOMIZE_VERSION_linux_arm64.tar.gz
    mv kustomize /usr/local/bin/
    chmod +x /usr/local/bin/kustomize

    # Install kubectl
    echo "Install kubectl"
    curl -LO https://dl.k8s.io/release/$KUBECTL_VERSION/bin/linux/arm64/kubectl
    mv kubectl /usr/local/bin/
    chmod +x /usr/local/bin/kubectl

    # Install awscli
    echo "Install awscli"
    curl -O 'https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip'
    unzip awscli-exe-linux-aarch64.zip
    ./aws/install

    # Install argocd
    Echo "Install argocd"
    curl -Lo argocd-linux-arm64 https://github.com/argoproj/argo-cd/releases/download/$ARGOCD_VERSION/argocd-linux-arm64
    chmod +x argocd-linux-arm64
    mv argocd-linux-arm64 /usr/local/bin/argocd

    # Cleanup
    rm -rf aws awscli-exe-linux-aarch64.zip
    rm -rf kustomize_$KUSTOMIZE_VERSION_linux_arm64.tar.gz 
    rm -rf argocd-linux-arm64

    echo kustomize version
    kustomize version
    echo " "

    echo terraform version
    terraform version
    echo " " 

    echo kubectl version
    kubectl version
    echo " "

    echo aws version
    aws --version
    echo " "

    echo argocd version
    argocd version
    echo " "

    echo helm version
    helm version
    echo " "

    echo ansible version
    ansible --version
    echo " "

    tail -f /dev/null
